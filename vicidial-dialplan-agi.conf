; =============================================================================
; VICIdial DID Optimizer - AGI-Based Dialplan Integration
;
; INSTALLATION INSTRUCTIONS:
; 1. Add this section to your /etc/asterisk/extensions.conf
; 2. Insert BEFORE your existing [vicidial-auto] context
; 3. Configure campaigns to use "COMPAT_DID_OPTIMIZER" as Outbound Caller ID
; =============================================================================

; DID Optimizer Context - Insert this BEFORE [vicidial-auto]
[did-optimizer]
; This context intercepts calls from campaigns using COMPAT_DID_OPTIMIZER

; Step 1: Get call parameters from VICIdial variables
exten => _X.,1,NoOp(=== DID Optimizer: Processing ${EXTEN} ===)
exten => _X.,n,Set(CUSTOMER_PHONE=${EXTEN})
exten => _X.,n,Set(CAMPAIGN_ID=${campaign})
exten => _X.,n,Set(AGENT_ID=${agent})

; Step 2: Call DID optimizer AGI script
exten => _X.,n,AGI(agi-did-optimizer.agi,${CAMPAIGN_ID},${AGENT_ID},${CUSTOMER_PHONE})

; Step 3: Set the optimized caller ID (set by AGI)
exten => _X.,n,Set(CALLERID(num)=${OPTIMIZED_DID})
exten => _X.,n,Set(CALLERID(name)=)

; Step 4: Log the selection and continue to normal VICIdial processing
exten => _X.,n,NoOp(DID Optimizer: Selected ${OPTIMIZED_DID} for campaign ${CAMPAIGN_ID})
exten => _X.,n,Goto(vicidial-auto,${EXTEN},1)

; Call completion handler - reports results back to API
exten => h,1,NoOp(=== DID Optimizer: Call completed - ${DIALSTATUS} ===)
exten => h,n,AGI(agi-did-optimizer-report.agi,${CAMPAIGN_ID},${CUSTOMER_PHONE},${DIALSTATUS},${ANSWEREDTIME},${disposition})
exten => h,n,Hangup()

; =============================================================================
; MODIFY YOUR EXISTING [vicidial-auto] CONTEXT
; Add this as the FIRST line in your [vicidial-auto] context:
; =============================================================================

[vicidial-auto]
; ADD THIS LINE FIRST - intercept DID optimizer campaigns
exten => _X.,1,GotoIf($["${CALLERID(num)}" = "COMPAT_DID_OPTIMIZER"]?did-optimizer,${EXTEN},1)

; Your existing VICIdial dialplan continues below...
; exten => _X.,n,AGI(agi-VDAD_ALL_outbound.agi,NORMAL)
; exten => _X.,n,Dial(${TESTSIPTRUNK}/${EXTEN:1},,To)
; exten => _X.,n,Hangup

; =============================================================================
; ALTERNATIVE: Integration using existing VICIdial AGI structure
; Use this if you prefer to integrate within existing AGI calls
; =============================================================================

[did-optimizer-inline]
; Inline version that works with existing VICIdial AGI structure
exten => _X.,1,NoOp(=== DID Optimizer: Inline Processing ===)
exten => _X.,n,Set(CUSTOMER_PHONE=${EXTEN})
exten => _X.,n,Set(CAMPAIGN_ID=${campaign})
exten => _X.,n,Set(AGENT_ID=${agent})

; Call the DID optimizer and get result directly
exten => _X.,n,Set(OPTIMIZED_DID=${SHELL(/usr/share/astguiclient/agi-bin/did-optimizer-quick.pl "${CAMPAIGN_ID}" "${AGENT_ID}" "${CUSTOMER_PHONE}")})
exten => _X.,n,Set(CALLERID(num)=${OPTIMIZED_DID})
exten => _X.,n,NoOp(DID Optimizer: Using ${OPTIMIZED_DID})

; Continue with standard VICIdial processing
exten => _X.,n,AGI(agi-VDAD_ALL_outbound.agi,NORMAL)
exten => _X.,n,Dial(${TESTSIPTRUNK}/${EXTEN:1},,To)
exten => _X.,n,Hangup

; =============================================================================
; CAMPAIGN CONFIGURATION IN VICIDIAL ADMIN:
;
; Method 1 - DID Optimizer Override:
; 1. Login to VICIdial Admin Interface
; 2. Go to: Admin → Campaigns → [Select Your Campaign]
; 3. Scroll to "Outbound Caller ID Options"
; 4. Set these fields:
;    - Outbound Caller ID: COMPAT_DID_OPTIMIZER
;    - Campaign CID Override: Y
; 5. Click "SUBMIT" to save
;
; Method 2 - Custom Dialplan Override:
; 1. In Campaign settings, find "Dial Plan"
; 2. Change from "vicidial-auto" to "did-optimizer-inline"
; 3. This will use the inline version above
;
; The campaign will now automatically use DID optimization for all calls!
; =============================================================================