; =============================================================================
; VICIdial DID Optimizer - Simple Dialplan Integration
;
; INSTALLATION INSTRUCTIONS:
; 1. Add this section to your /etc/asterisk/extensions.conf
; 2. Insert BEFORE your existing [vicidial-auto] context
; 3. Configure campaigns to use "COMPAT_DID_OPTIMIZER" as Outbound Caller ID
; =============================================================================

; DID Optimizer Context - Insert this BEFORE [vicidial-auto]
[did-optimizer]
; This context intercepts calls from campaigns using COMPAT_DID_OPTIMIZER

; Step 1: Get call parameters from VICIdial variables
exten => _X.,1,NoOp(=== DID Optimizer: Processing ${EXTEN} ===)
exten => _X.,n,Set(CUSTOMER_PHONE=${EXTEN})
exten => _X.,n,Set(CAMPAIGN_ID=${campaign})
exten => _X.,n,Set(AGENT_ID=${agent})

; Step 2: Get customer location from VICIdial database
exten => _X.,n,MYSQL(Connect connid localhost cron 1234 asterisk)
exten => _X.,n,MYSQL(Query resultid ${connid} SELECT state,postal_code FROM vicidial_list WHERE phone_number='${CUSTOMER_PHONE}' LIMIT 1)
exten => _X.,n,MYSQL(Fetch fetchid ${resultid} CUSTOMER_STATE CUSTOMER_ZIP)
exten => _X.,n,MYSQL(Clear ${resultid})
exten => _X.,n,MYSQL(Disconnect ${connid})

; Step 3: Call DID optimizer script
exten => _X.,n,System(/usr/share/astguiclient/vicidial-did-optimizer-config.pl "${CAMPAIGN_ID}" "${AGENT_ID}" "${CUSTOMER_PHONE}" "${CUSTOMER_STATE}" "${CUSTOMER_ZIP}" > /tmp/did_${CAMPAIGN_ID}_${UNIQUEID})

; Step 4: Read selected DID and set as caller ID
exten => _X.,n,Set(SELECTED_DID=${FILE(/tmp/did_${CAMPAIGN_ID}_${UNIQUEID})})
exten => _X.,n,System(rm -f /tmp/did_${CAMPAIGN_ID}_${UNIQUEID})
exten => _X.,n,Set(CALLERID(num)=${SELECTED_DID})
exten => _X.,n,Set(CALLERID(name)=)

; Step 5: Log the selection and continue to normal VICIdial processing
exten => _X.,n,NoOp(DID Optimizer: Selected ${SELECTED_DID} for campaign ${CAMPAIGN_ID})
exten => _X.,n,Goto(vicidial-auto,${EXTEN},1)

; Call completion handler - reports results back to API
exten => h,1,NoOp(=== DID Optimizer: Call completed - ${DIALSTATUS} ===)
exten => h,n,Set(RESULT=${DIALSTATUS})
exten => h,n,Set(DURATION=${ANSWEREDTIME})
exten => h,n,Set(DISPOSITION=${disposition})
exten => h,n,System(/usr/share/astguiclient/vicidial-did-optimizer-config.pl --report "${CAMPAIGN_ID}" "${CUSTOMER_PHONE}" "${RESULT}" "${DURATION}" "${DISPOSITION}")
exten => h,n,Hangup()

; =============================================================================
; MODIFY YOUR EXISTING [vicidial-auto] CONTEXT
; Add this as the FIRST line in your [vicidial-auto] context:
; =============================================================================

[vicidial-auto]
; ADD THIS LINE FIRST - intercept DID optimizer campaigns
exten => _X.,1,GotoIf($["${CALLERID(num)}" = "COMPAT_DID_OPTIMIZER"]?did-optimizer,${EXTEN},1)

; ... rest of your existing [vicidial-auto] dialplan continues here ...
; exten => _X.,n,AGI(agi-VDAD_ALL_outbound.agi,NORMAL)
; exten => _X.,n,... (your existing dialplan)

; =============================================================================
; ALTERNATIVE: Shorter version using System() call directly
; Replace the [did-optimizer] context above with this simpler version:
; =============================================================================

[did-optimizer-simple]
exten => _X.,1,NoOp(=== DID Optimizer Simple ===)
exten => _X.,n,Set(SELECTED_DID=${SHELL(/usr/share/astguiclient/vicidial-did-optimizer-config.pl "${campaign}" "${agent}" "${EXTEN}")})
exten => _X.,n,Set(CALLERID(num)=${SELECTED_DID})
exten => _X.,n,NoOp(Using DID: ${SELECTED_DID})
exten => _X.,n,Goto(vicidial-auto,${EXTEN},1)

exten => h,1,System(/usr/share/astguiclient/vicidial-did-optimizer-config.pl --report "${campaign}" "${EXTEN}" "${DIALSTATUS}" "${ANSWEREDTIME}" "${disposition}")
exten => h,n,Hangup()

; =============================================================================
; CAMPAIGN CONFIGURATION IN VICIDIAL ADMIN:
;
; 1. Login to VICIdial Admin Interface
; 2. Go to: Admin → Campaigns → [Select Your Campaign]
; 3. Scroll to "Outbound Caller ID Options"
; 4. Set these fields:
;    - Outbound Caller ID: COMPAT_DID_OPTIMIZER
;    - Campaign CID Override: Y
; 5. Click "SUBMIT" to save
;
; The campaign will now automatically use DID optimization for all calls!
; =============================================================================